const SFConstants={SITE:{},FIREBASE:{AppJs:"https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js",AuthJS:"https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"},CMS_COMPATIBILITY:{sitejet:"sitejet"},EVENTS:{loginSuccess:"sitefellows/login",loginError:"sitefellows/login-error",configLoaded:"sitefellow/config-loaded",configLoadedAndHTMLLoaded:"sitefellow/config-and-html-loaded"}},SFUtils={UUID:function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16))},IsB64:function(str){if(""===str||""===str.trim())return!1;try{return btoa(atob(str))==str}catch(err){return!1}},B64Encode:function(string){return btoa(unescape(encodeURIComponent(string)))},B64Decode:function(string){return decodeURIComponent(escape(atob(string)))},CheckIfHTMLElementExists:function(selector){return!!document.querySelectorAll(selector).length},CheckIfEmailAddressIsValid:function(email){var emailMatch;return!!String(email).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)},RedirectToURL:function(url){window.location.href=url},ShowHideElements:function(query,state){let queryElements;document.querySelectorAll(query).forEach((function(element){element.style.visibility=state?"visible":"hidden !important",element.style.display=state?null:"none"}))},ShowLoader:function(show){console.log("ShowLoader",show),show&&document.body?document.body.setAttribute("data-sf-loader",""):document.body.setAttribute("data-sf-loader","ok")},MakeSelectorCompatibleWithCMS:function(selector,cms){switch(cms.toLowerCase()){case SFConstants.CMS_COMPATIBILITY.sitejet:return"body:not(.edit) "+selector;default:return selector}},IsInCMSEditor:function(cms){switch(cms.toLowerCase()){case SFConstants.CMS_COMPATIBILITY.sitejet:return!!window.editor;default:return!1}},GetLocalStoreConfig:function(){var storage,localData=window.localStorage.getItem("sitefellows-config");return localData?JSON.parse(localData):null},GetLocalStoreUser:function(){var storage,localData=window.localStorage.getItem("sitefellows-user");return localData?JSON.parse(localData):null},GetLocalStoreUserRoles:function(){var storage,localData=window.localStorage.getItem("sitefellows-user-roles");return localData?JSON.parse(localData):null}},SiteFellows=function(){var _SITEFELLOWS_CONFIG;function getScriptAttributeData(key){var docH=document.head,hMLKeyData;return sElements=docH.querySelectorAll("script"),sElements.forEach((function(sElement){var mlKey=sElement.getAttribute(key);mlKey&&(hMLKeyData=mlKey)})),hMLKeyData}async function fetchDocumentFromURL(type,url){try{const response=await fetch(url);return await((type="json")?response.json():response.text())}catch(err){console.warn("File fetching error:",err)}}function createScriptTag(url,callback){var scriptTag=document.createElement("script");scriptTag.setAttribute("src",url),callback&&(scriptTag.onload=callback),document.head.appendChild(scriptTag)}async function initializeConfig(){var storage=window.localStorage,localSiteConfig=storage.getItem("sitefellows-config"),localSiteConfigTimestamp=storage.getItem("sitefellows-config-timestamp"),localSiteConfigTimestampDate=localSiteConfigTimestamp?new Date(localSiteConfigTimestamp):null,timestamDifference=new Date(Date.now())-localSiteConfigTimestampDate;if(localSiteConfig&&timestamDifference<6e5)_SITEFELLOWS_CONFIG=JSON.parse(localSiteConfig);else{var serverSiteConfigData=getScriptAttributeData("data-site-config"),serverSiteConfig=await fetchDocumentFromURL("json",serverSiteConfigData);localStorage.setItem("sitefellows-config",JSON.stringify(serverSiteConfig)),storage.setItem("sitefellows-config-timestamp",new Date(Date.now())),_SITEFELLOWS_CONFIG=serverSiteConfig}}function initializeFirebase(){createScriptTag(SFConstants.FIREBASE.AppJs,(function(){createScriptTag(SFConstants.FIREBASE.AuthJS,(function(){firebase.initializeApp(_SITEFELLOWS_CONFIG.FIREBASE),bindFirebaseOnAuthStateChangedEvent()}))}))}function bindFirebaseOnAuthStateChangedEvent(){firebase.auth().onAuthStateChanged(user=>{var storage=window.localStorage;user?storage.setItem("sitefellows-user",JSON.stringify(getUserDataFromFirebaseAuthUser(user))):storage.removeItem("sitefellows-user"),applyURLRules(),SiteFellowsUI.Update()})}function getUserDataFromFirebaseAuthUser(firebaseUser){return firebaseUser?{displayName:firebaseUser.displayName,email:firebaseUser.email,emailVerified:firebaseUser.emailVerified,photoURL:firebaseUser.photoURL,creationTime:firebaseUser.metadata.creationTime,lastSignInTime:firebaseUser.metadata.lastSignInTime,uid:firebaseUser.uid,refreshToken:firebaseUser.refreshToken}:null}function matchExactString(rule,str){var match=str.match(rule);return match&&str===match[0]}function firebaseSignInWithEmail(email,password,redirectOnSuccessURL){firebase.auth().signInWithEmailAndPassword(email,password).then((function(userCredential){var user=userCredential.user,storage;window.localStorage.setItem("sitefellows-user",JSON.stringify(getUserDataFromFirebaseAuthUser(user)));const loginSuccessEvent=new CustomEvent("sitefellows/login");document.dispatchEvent(loginSuccessEvent),redirectOnSuccessURL&&SFUtils.RedirectToURL(redirectOnSuccessURL)})).catch((function(error){var errorCode=error.code,errorMessage=error.message;console.warn("Firebase login error:",errorCode,errorMessage);const loginErrorEvent=new CustomEvent("sitefellows/login-error",{detail:errorMessage});document.dispatchEvent(loginErrorEvent)}))}function firebaseSignOut(){firebase.auth().signOut().then((function(){var storage;window.localStorage.removeItem("sitefellows-user")}),(function(error){}))}function getRuleBasedOnURLPath(){var rules=_SITEFELLOWS_CONFIG.SITE.rules,searchResults=[];const currentPath=window.location.pathname;if(rules.forEach((function(rule){switch(rule.type.toLowerCase()){case"exact":matchExactString(rule.path,currentPath)&&searchResults.push({roles:rule.roles,ranking:2,path:rule.path});break;case"starstwith":currentPath.startsWith(rule.path)&&searchResults.push({roles:rule.roles,ranking:1,path:rule.path})}})),searchResults.length>0){var maxRanking=0,bestMatchingPath=0,bestRule;return searchResults.forEach((function(match){maxRanking=match.ranking>maxRanking?match.ranking:maxRanking,(bestMatchingPath=match.path.length>bestMatchingPath?match.path.length:bestMatchingPath)==match.path.length&&maxRanking==match.ranking&&(bestRule=match)})),{path:bestRule.path,roles:bestRule.roles}}}function applyURLRules(){let authUser=SFUtils.GetLocalStoreUser(),authUserRoles=SFUtils.GetLocalStoreUserRoles(),matchingRuleForURL=getRuleBasedOnURLPath()?getRuleBasedOnURLPath():null;if(matchingRuleForURL)if(authUser){var foundRoles;if(authUserRoles)if(0==authUserRoles.filter((function(authRole){let foundRole;return matchingRuleForURL.roles&&matchingRuleForURL.roles.forEach((function(mRole){mRole==authRole&&(foundRole=authRole)})),foundRole})).length){let redirectURL=_SITEFELLOWS_CONFIG.SITE.paths.restricted?_SITEFELLOWS_CONFIG.SITE.paths.restricted:"/";SFUtils.RedirectToURL(redirectURL)}}else{let redirectURL=_SITEFELLOWS_CONFIG.SITE.paths.login?_SITEFELLOWS_CONFIG.SITE.paths.login:"/";SFUtils.RedirectToURL(redirectURL)}}return{_Init:async function(){await initializeConfig();const configLoadedEvent=new Event("sitefellow/config-loaded");document.dispatchEvent(configLoadedEvent),initializeFirebase(),SFUtils.IsInCMSEditor(SFUtils.GetLocalStoreConfig().SITE.options.cmsCompatibility)||applyURLRules()},UserLoginWithEmail:function(email,password,redirectOnSuccessURL){firebaseSignInWithEmail(email,password,redirectOnSuccessURL)},UserSignOut:function(){firebaseSignOut()},ClearCache:function(){var storage=window.localStorage;storage.removeItem("sitefellows-config"),storage.removeItem("sitefellows-config-timestamp"),storage.removeItem("sitefellows-user"),firebaseSignOut()}}}(),SiteFellowsUI=function(){function showFormErrorMessage(errorSelector,message){errorSelector.innerText=message,errorSelector.classList.add("show")}function checkIfFormFieldIsEmpty(fieldSelector,errorMessageSelector,message){return 0==fieldSelector.value.length&&(showFormErrorMessage(errorMessageSelector,message),!0)}function checkIfEmailFieldIsValid(fieldSelector,errorMessageSelector,message){return!SFUtils.CheckIfEmailAddressIsValid(fieldSelector.value)&&(showFormErrorMessage(errorMessageSelector,message),!0)}function updateUI(){var storage=window.localStorage;let userData=SFUtils.GetLocalStoreUser();if(!SFUtils.IsInCMSEditor(SFUtils.GetLocalStoreConfig().SITE.options.cmsCompatibility)){let allModals;document.querySelectorAll(".sf-generated-modal").forEach((function(modalElement){modalElement.remove()})),SFUtils.CheckIfHTMLElementExists('[href="#sf-login"]')&&SFUtils.ShowHideElements('[href="#sf-login"]',!userData),SFUtils.CheckIfHTMLElementExists('[href="#sf-login-modal"]')&&SFUtils.ShowHideElements('[href="#sf-login-modal"]',!userData),SFUtils.CheckIfHTMLElementExists('[href="#sf-register"]')&&SFUtils.ShowHideElements('[href="#sf-register"]',!userData),SFUtils.CheckIfHTMLElementExists('[href="#sf-logout"]')&&SFUtils.ShowHideElements('[href="#sf-logout"]',!!userData),SFUtils.CheckIfHTMLElementExists(".sf-login-form")&&SFUtils.ShowHideElements(".sf-login-form",!userData),SFUtils.CheckIfHTMLElementExists(".sf-register-form")&&SFUtils.ShowHideElements(".sf-register-form",!userData)}}function createModalAndReturnContentSelector(title="",footer=""){const modalID=`data-id="${SFUtils.UUID()}"`,footerMarkup=footer?`<div class="sh-footer">${footer}</div>`:"";let modalMarkup=`\n        <div class="sf-modal-container" ${modalID}>\n        <div class="sf-modal">\n            <div class="sf-header">\n                <p class="sf-title">${title}</p>\n                <div class="sf-button"></div>\n            </div>\n            <div class="sf-content"></div>\n            ${footerMarkup}\n        </div>\n        </div>`;var modalContentElement=document.createElement("div"),closeButton;return modalContentElement.classList.add("sf-generated-modal"),modalContentElement.innerHTML=modalMarkup,document.querySelector("body").appendChild(modalContentElement),document.querySelector("["+modalID+"].sf-modal-container .sf-button").addEventListener("click",(function(e){modalContentElement.remove()})),`.sf-modal-container[${modalID}] .sf-content`}function renderLogin(container,redirectOnSuccessURL){const formID=`data-id="${SFUtils.UUID()}"`,formMarkup=`\n        <div class="sf-login-form sf-form-container" ${formID}>\n        <div class="sf-form">\n            <div class="sf-form-field">\n                <label for="sf-login-user-email">Email</label>\n                <input type="email" name="sf-login-user-email" id="sf-login-user-email" placeholder="your.email@example.com">\n            </div>\n\n            <div class="sf-form-field">\n                <label for="sf-login-user-pass">Password</label>\n                <input type="password" name="sf-login-user-pass" id="sf-login-user-pass" placeholder="Enter your password">\n            </div>\n            <div class="sf-error-message">Error Message</div>\n            <button class="sf-button submit">Log in</button>\n        </div>\n    </div>`;if(SFUtils.CheckIfHTMLElementExists(container)){const formIDSelector="["+formID+"]";var formSubmitSignature;document.querySelector(container).innerHTML=formMarkup;var loginForm=document.querySelector(formIDSelector+".sf-login-form"),loginEmail=document.querySelector(formIDSelector+".sf-login-form #sf-login-user-email"),loginPass=document.querySelector(formIDSelector+".sf-login-form #sf-login-user-pass"),errorMessage=document.querySelector(formIDSelector+".sf-login-form .sf-error-message"),loginButton;function validateLoginForm(email,pass,message){var hasError,hasError,hasError;return!(hasError=checkIfFormFieldIsEmpty(email,message,"Email can't be empty."))&&(!(hasError=checkIfEmailFieldIsValid(email,message,"Email address is not valid."))&&!(hasError=checkIfFormFieldIsEmpty(pass,message,"Password can't be empty.")))}document.querySelector(formIDSelector+".sf-login-form .sf-button.submit").addEventListener("click",(function(e){errorMessage.classList.remove("show"),validateLoginForm(loginEmail,loginPass,errorMessage)&&(loginForm.classList.add("load"),formSubmitSignature=formID,SiteFellows.UserLoginWithEmail(loginEmail.value,loginPass.value,redirectOnSuccessURL))})),document.addEventListener("sitefellows/login-error",(function(e){formSubmitSignature==formID&&showFormErrorMessage(errorMessage,e.detail),loginForm.classList.remove("load")})),document.addEventListener("sitefellows/login",(function(e){loginForm.classList.remove("load"),updateUI()}))}}function bindClickToSiteRedirect(selector,redirectKey,callbackFunction){if(SFUtils.CheckIfHTMLElementExists(selector)){let htmlElement;document.querySelector(selector).addEventListener("click",(function(e){let localConfig=SFUtils.GetLocalStoreConfig();callbackFunction&&callbackFunction(),SFUtils.RedirectToURL(localConfig.SITE.paths[redirectKey]?localConfig.SITE.paths[redirectKey]:""),e.preventDefault(),e.stopPropagation()}))}}function bindUIEvents(){if(!SFUtils.IsInCMSEditor(SFUtils.GetLocalStoreConfig().SITE.options.cmsCompatibility)){bindClickToSiteRedirect('[href="#sf-login"]',"login"),bindClickToSiteRedirect('[href="#sf-register"]',"register"),bindClickToSiteRedirect('[href="#sf-logout"]',"",(function(){SiteFellows.UserSignOut()}));let loginModalSelector='[href="#sf-login-modal"]';if(SFUtils.CheckIfHTMLElementExists(loginModalSelector)){let loginModalButton;document.querySelector(loginModalSelector).addEventListener("click",(function(e){let loginContentSelector;renderLogin(createModalAndReturnContentSelector("Login")),e.preventDefault(),e.stopPropagation()}))}}}function checkIfConfigLoadedAndHTMLIsLoaded(){var configLoaded=!1,htmlLoaded=!1;function isConfigLoadedAndHTMLLoaded(){if(configLoaded&&htmlLoaded){const configLoadedAndHTMLLoaded=new Event("sitefellow/config-and-html-loaded");document.dispatchEvent(configLoadedAndHTMLLoaded)}}document.addEventListener("sitefellow/config-loaded",(function(){configLoaded=!0,isConfigLoadedAndHTMLLoaded()})),document.addEventListener("DOMContentLoaded",(function(e){htmlLoaded=!0,isConfigLoadedAndHTMLLoaded()}))}return{_Init:function(){checkIfConfigLoadedAndHTMLIsLoaded(),document.addEventListener("sitefellow/config-and-html-loaded",(function(){bindUIEvents(),updateUI(),SFUtils.GetLocalStoreConfig()&&SFUtils.ShowLoader(!1)}))},RenderLoginForm:function(container,redirectOnSuccessURL){renderLogin(container,redirectOnSuccessURL)},RenderLoginModal:function(redirectOnSuccessURL){var loginContentSelector;renderLogin(createModalAndReturnContentSelector("Login"))},DisplayRule:function(container,visibility,roles){},Update:function(){updateUI()}}}();SiteFellows._Init(),SiteFellowsUI._Init();